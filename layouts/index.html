{{ partial "head.html" . }}
  <body>
    <div id="blog">
      {{ partial "header.html" . }}
      {{ partial "sidebar.html" . }}
      {{ partial "post/header-cover.html" . }}
      <div id="main"
        class="{{ with .Params.coverimage }}hasCover{{ end }}
               {{ if eq .Params.covermeta "out" }}hasCoverMetaOut{{ else }}hasCoverMetaIn{{ end }}
               {{ with .Params.coverCaption }}hasCoverCaption{{ end }}">
        
        <section class="main-content-wrap glass-portfolio">
          
          <!-- Language-aware category order -->
          {{- $isEnglish := eq .Site.Language.Lang "en" }}
          {{- $categoryOrder := slice }}
          {{- if $isEnglish }}
            {{- $categoryOrder = slice "Personal Experience" "Professional Technology" "Master's Thesis" "Graduate Project" "Undergraduate Project" }}
          {{- else }}
            {{- $categoryOrder = slice "個人經歷" "專業技術" "研究所論文" "研究生專題" "大學生專題" }}
          {{- end }}
          
          
          <!-- Filter Bar -->
          <div class="glass-filter-bar">
            <div class="filter-tabs">
              <button class="filter-tab active" data-filter="all">{{ if $isEnglish }}All{{ else }}全部{{ end }}</button>
              {{- range $catName := $categoryOrder }}
                {{- $catKey := cond $isEnglish ($catName | lower) $catName }}
                {{- if index $.Site.Taxonomies.categories $catKey }}
              <button class="filter-tab" data-filter="{{ $catName | urlize }}">{{ $catName }}</button>
                {{- end }}
              {{- end }}
            </div>
            <div class="filter-controls">
              <select id="year-filter" class="year-select">
                <option value="all">All Years</option>
                {{- $years := slice }}
                {{- range (where .Site.RegularPages "Type" "in" site.Params.mainSections) }}
                  {{- $year := .Date.Format "2006" }}
                  {{- if not (in $years $year) }}
                    {{- $years = $years | append $year }}
                  {{- end }}
                {{- end }}
                {{- range (sort $years "value" "desc") }}
                <option value="{{ . }}">{{ . }}</option>
                {{- end }}
              </select>
            </div>
          </div>

          
          <!-- Category Sections -->
          <div class="portfolio-content">
            {{- range $catName := $categoryOrder }}
              {{- $catKey := cond $isEnglish ($catName | lower) $catName }}
              {{- $allPages := index $.Site.Taxonomies.categories $catKey }}
              {{- $pages := slice }}
              {{- if $allPages }}
                {{- range $allPages.Pages }}
                  {{- if eq .Lang $.Site.Language.Lang }}
                    {{- $pages = $pages | append . }}
                  {{- end }}
                {{- end }}
              {{- end }}
              {{- if $pages }}
              <div class="category-section" data-category="{{ $catName | urlize }}">
                <h2 class="category-title">{{ $catName }}</h2>
                <div class="cards-container">
                  {{- range $pages }}
                  <article class="glass-card" 
                           data-category="{{ $catName | urlize }}" 
                           data-year="{{ .Date.Format "2006" }}"
                           data-tags="{{ range .Params.tags }}{{ . | urlize }} {{ end }}">
                    
                    {{- $thumbnailImage := "" }}
                    {{- if .Params.thumbnailImage }}
                      {{- $thumbnailImage = .Params.thumbnailImage }}
                    {{- else if .Params.coverImage }}
                      {{- $thumbnailImage = .Params.coverImage }}
                    {{- end }}
                    
                    {{- if $thumbnailImage }}
                    <a href="{{ .RelPermalink }}" class="card-image-link">
                      <div class="card-image">
                        <img alt="{{ .Title }}" src="{{ $thumbnailImage }}" loading="lazy"/>
                      </div>
                    </a>
                    {{- end }}

                    <div class="card-header-top">
                      <h3 class="card-title">
                        <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                      </h3>
                    </div>
                    
                    <div class="card-content">
                      <p class="card-description">
                        {{- if .Params.Summary }}
                          {{ .Params.Summary | markdownify | plainify | truncate 150 }}
                        {{- else }}
                          {{ .Summary | plainify | truncate 150 }}
                        {{- end }}
                      </p>
                      <div class="card-extra-text">...more like</div>
                      
                      {{- with .Params.tags }}
                      <div class="card-tags">
                        {{- range first 4 . }}
                        <span class="tag-pill">#{{ . }}</span>
                        {{- end }}
                      </div>
                      {{- end }}
                      
                      <a href="{{ .RelPermalink }}" class="card-read-more">Read More →</a>
                    </div>
                  </article>
                  {{- end }}
                </div>
              </div>
              {{- end }}
            {{- end }}
          </div>

          
        </section>
        {{ partial "footer.html" . }}
      </div>
    </div>

    <!-- Filter JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      const tabs = document.querySelectorAll('.filter-tab');
      const yearSelect = document.getElementById('year-filter');
      const cards = document.querySelectorAll('.glass-card');
      const sections = document.querySelectorAll('.category-section');
      
      function filterContent() {
        const activeTab = document.querySelector('.filter-tab.active');
        const categoryFilter = activeTab ? activeTab.dataset.filter : 'all';
        const yearFilter = yearSelect ? yearSelect.value : 'all';
        
        // Filter cards
        cards.forEach(card => {
          const cardCategory = card.dataset.category;
          const cardYear = card.dataset.year;
          
          const matchCategory = categoryFilter === 'all' || cardCategory === categoryFilter;
          const matchYear = yearFilter === 'all' || cardYear === yearFilter;
          
          if (matchCategory && matchYear) {
            // Show card
            card.style.display = 'flex'; // Restore Grid/Flex behavior
            card.classList.remove('is-hidden');
            card.classList.add('fade-in');
          } else {
            // Hide card
            card.style.display = 'none';
            card.classList.add('is-hidden');
            card.classList.remove('fade-in');
          }
        });
        
        // Show/hide category sections
        sections.forEach(section => {
            const sectionCategory = section.dataset.category;
            // Check if this section has any VISIBLE cards NOT hidden
            const visibleCards = section.querySelectorAll('.glass-card:not(.is-hidden)');
            
            if (visibleCards.length > 0) {
                 section.style.display = 'block';
            } else {
                 section.style.display = 'none';
            }
        });
      }
      
      // Tab click handler
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          tabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          filterContent();
          
          // Scroll to top of filters to avoid getting lost
          document.querySelector('.glass-filter-bar').scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
          });
        });
      });
      
      // Year select handler
      if (yearSelect) {
        yearSelect.addEventListener('change', filterContent);
      }
    });
    </script>

{{ partial "foot.html" . }}
